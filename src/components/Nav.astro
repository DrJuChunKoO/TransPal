---
import Search from "./Search";
import DarkModeToggle from "./DarkModeToggle";

// Get current path for navigation logic
const currentPath = Astro.url.pathname;
const isIndex = currentPath === "/";
const isMessage = /\/speeches\/[^/]+\/[^/]+/.test(currentPath);
---

<nav
  class="sticky top-0 z-10 bg-white/90 shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] backdrop-blur-xl dark:bg-[#232323]/90 dark:shadow-[0_-1px_0_rgba(255,255,255,.1)_inset]"
  role="navigation"
  aria-label="主要導航"
>
  <div class="relative mx-auto flex flex-col gap-2 px-4 py-2 sm:px-6">
    <div class="flex min-h-[2rem] items-center justify-between gap-2 sm:gap-4">
      <div class="flex min-w-0 items-center">
        {
          !isIndex && (
            <button
              id="back-button"
              class="mr-2 flex min-h-[44px] min-w-[44px] touch-manipulation items-center justify-center rounded-lg p-2 hover:bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:outline-none active:bg-gray-200 dark:hover:bg-white/5 dark:focus:ring-offset-gray-800 dark:active:bg-white/10"
              data-is-message={isMessage}
              data-current-path={currentPath}
              aria-label="返回上一頁"
              type="button"
            >
              <svg
                class="size-5 sm:size-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>
          )
        }
        <a
          href="/"
          class="-m-2 flex min-w-0 items-center gap-2 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:outline-none dark:focus:ring-offset-gray-800"
          aria-label="TransPal 首頁"
        >
          <div
            class="truncate text-lg font-semibold tracking-tighter text-gray-800 sm:text-xl dark:text-white"
          >
            TransPal
          </div>
        </a>
      </div>
      <div
        class="flex flex-shrink-0 items-center gap-1 sm:gap-2"
        role="toolbar"
        aria-label="搜尋和設定工具"
      >
        <Search client:load />
        <DarkModeToggle client:load />
      </div>
    </div>
  </div>
</nav>

<script>
  // Handle back button navigation
  const backButton = document.getElementById("back-button");
  if (backButton) {
    backButton.addEventListener("click", () => {
      const isMessage = backButton.getAttribute("data-is-message") === "true";
      const currentPath = backButton.getAttribute("data-current-path");

      if (isMessage && currentPath) {
        // For message pages, go back to the speech page with anchor
        const pathParts = currentPath.split("/");
        const messageId = pathParts[pathParts.length - 1];
        const speechPath = pathParts.slice(0, -1).join("/");
        window.location.href = `${speechPath}#${messageId}`;
      } else {
        // For other pages, go back to home
        window.location.href = "/";
      }
    });
  }
</script>
